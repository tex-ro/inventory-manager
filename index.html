<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-100 min-h-screen">
    <div id="root"></div>
    
    <script type="module">
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDgMPg7OXnYW03cRKw2Gs7CMJXeY6WqZai0kI5zQ8ysYwqMu0RMUyUZC4CxOsQOWKi/exec';
        
        let products = [];
        let categories = ['Electronics', 'Clothing', 'Food', 'Furniture', 'Books', 'Others'];
        let searchTerm = '';
        let filterCategory = 'All';
        let filterStatus = 'All';
        let scanning = false;
        let scanAction = null;
        let showAddForm = false;
        let editingProduct = null;
        let showSettings = false;
        let defaultThreshold = 10;
        let syncing = false;
        let lastSync = null;
        let newProduct = {
            productCode: '',
            barcode: '',
            name: '',
            category: 'Others',
            openingStock: 0,
            purchased: 0,
            sold: 0,
            unitCost: 0,
            threshold: 10
        };

        // Load data from Google Sheets on startup
        async function loadFromGoogleSheets() {
            try {
                syncing = true;
                render();
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const data = await response.json();
                if (data.products && data.products.length > 0) {
                    products = data.products.map(p => ({...p, id: Date.now() + Math.random()}));
                }
                lastSync = new Date();
                syncing = false;
                render();
            } catch (error) {
                console.error('Failed to load from Google Sheets:', error);
                syncing = false;
                render();
            }
        }

        // Save data to Google Sheets
        async function saveToGoogleSheets() {
            try {
                syncing = true;
                render();
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ products })
                });
                lastSync = new Date();
                syncing = false;
                render();
            } catch (error) {
                console.error('Failed to save to Google Sheets:', error);
                syncing = false;
                render();
            }
        }

        function calculateCurrentStock(product) {
            return product.openingStock + product.purchased - product.sold;
        }

        function calculateInventoryValue(product) {
            return calculateCurrentStock(product) * product.unitCost;
        }

        function getStatus(product) {
            const currentStock = calculateCurrentStock(product);
            if (currentStock <= 0) return { label: 'Out of Stock', color: 'text-red-600 bg-red-100' };
            if (currentStock <= product.threshold) return { label: 'Low Stock', color: 'text-orange-600 bg-orange-100' };
            return { label: 'OK', color: 'text-green-600 bg-green-100' };
        }

        function processBarcodeAction(barcode) {
            const product = products.find(p => p.barcode === barcode || p.productCode === barcode);
            
            if (scanAction === 'purchase' && product) {
                updateTransaction(product.id, 'purchased', 1);
            } else if (scanAction === 'sale' && product) {
                updateTransaction(product.id, 'sold', 1);
            } else if (!product) {
                newProduct.barcode = barcode;
                showAddForm = true;
                scanning = false;
                render();
            }
        }

        function updateTransaction(productId, type, amount) {
            products = products.map(p => 
                p.id === productId 
                    ? { ...p, [type]: Math.max(0, p[type] + amount) }
                    : p
            );
            saveToGoogleSheets();
            render();
        }

        function addProduct() {
            if (!newProduct.name || !newProduct.productCode) {
                alert('Please fill in Product Code and Name');
                return;
            }
            
            const product = {
                id: Date.now() + Math.random(),
                ...newProduct,
                openingStock: Number(newProduct.openingStock),
                purchased: Number(newProduct.purchased),
                sold: Number(newProduct.sold),
                unitCost: Number(newProduct.unitCost),
                threshold: Number(newProduct.threshold)
            };
            
            products.push(product);
            resetForm();
            saveToGoogleSheets();
            render();
        }

        function updateProduct() {
            products = products.map(p => 
                p.id === editingProduct.id ? { ...editingProduct } : p
            );
            editingProduct = null;
            saveToGoogleSheets();
            render();
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                products = products.filter(p => p.id !== productId);
                saveToGoogleSheets();
                render();
            }
        }

        function resetForm() {
            newProduct = {
                productCode: '',
                barcode: '',
                name: '',
                category: 'Others',
                openingStock: 0,
                purchased: 0,
                sold: 0,
                unitCost: 0,
                threshold: defaultThreshold
            };
            showAddForm = false;
            scanning = false;
        }

        function startScanning(action) {
            scanAction = action;
            scanning = true;
            render();
            setTimeout(() => document.getElementById('barcodeInput')?.focus(), 100);
        }

        const totalInventoryValue = products.reduce((sum, p) => sum + calculateInventoryValue(p), 0);
        const lowStockCount = products.filter(p => {
            const status = getStatus(p);
            return status.label === 'Low Stock' || status.label === 'Out of Stock';
        }).length;

        const filteredProducts = products.filter(p => {
            const matchesSearch = 
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                p.productCode.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (p.barcode && p.barcode.toLowerCase().includes(searchTerm.toLowerCase())) ||
                p.category.toLowerCase().includes(searchTerm.toLowerCase());
            
            const matchesCategory = filterCategory === 'All' || p.category === filterCategory;
            const status = getStatus(p);
            const matchesStatus = filterStatus === 'All' || status.label === filterStatus;
            
            return matchesSearch && matchesCategory && matchesStatus;
        });

        function render() {
            const app = document.getElementById('root');
            app.innerHTML = `
                <div class="max-w-7xl mx-auto p-4">
                    <!-- Header -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">Inventory Manager</h1>
                                    <p class="text-gray-500 text-sm">Track stock, purchases, and sales</p>
                                </div>
                            </div>
                            <div class="flex gap-3 items-center">
                                ${syncing ? `
                                    <div class="flex items-center gap-2 text-blue-600">
                                        <svg class="spinner w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                        <span class="text-sm">Syncing...</span>
                                    </div>
                                ` : lastSync ? `
                                    <div class="text-xs text-gray-500">
                                        Last synced: ${lastSync.toLocaleTimeString()}
                                    </div>
                                ` : ''}
                                <button onclick="showSettings = true; render()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200">
                                    ‚öôÔ∏è Settings
                                </button>
                                <button onclick="showAddForm = true; render()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    ‚ûï Add Product
                                </button>
                            </div>
                        </div>

                        <!-- Stats Dashboard -->
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                                <div class="text-sm font-medium mb-2">üí∞ Total Value</div>
                                <p class="text-2xl font-bold">‚Çπ${totalInventoryValue.toFixed(2)}</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                                <div class="text-sm font-medium mb-2">üì¶ Products</div>
                                <p class="text-2xl font-bold">${products.length}</p>
                            </div>
                            <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg">
                                <div class="text-sm font-medium mb-2">‚ö†Ô∏è Low Stock</div>
                                <p class="text-2xl font-bold">${lowStockCount}</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg">
                                <div class="text-sm font-medium mb-2">üìà Purchased</div>
                                <p class="text-2xl font-bold">${products.reduce((sum, p) => sum + p.purchased, 0)}</p>
                            </div>
                            <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-4 rounded-lg">
                                <div class="text-sm font-medium mb-2">üìâ Sold</div>
                                <p class="text-2xl font-bold">${products.reduce((sum, p) => sum + p.sold, 0)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Barcode Scanner -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">üîç Barcode Scanner</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="startScanning('purchase')" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4 rounded-lg font-semibold hover:from-green-700 hover:to-green-800">
                                üõí Scan for Purchase Entry
                            </button>
                            <button onclick="startScanning('sale')" class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-4 rounded-lg font-semibold hover:from-red-700 hover:to-red-800">
                                üí∞ Scan for Sales Entry
                            </button>
                        </div>
                        
                        ${scanning ? `
                            <div class="mt-4 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                                <p class="font-semibold text-blue-800 mb-2">
                                    ${scanAction === 'purchase' ? 'üì¶ Scan to record PURCHASE' : 'üí∞ Scan to record SALE'}
                                </p>
                                <input
                                    id="barcodeInput"
                                    type="text"
                                    placeholder="Scan barcode or type and press Enter..."
                                    class="w-full px-4 py-3 border-2 border-blue-400 rounded-lg focus:outline-none focus:border-blue-600 text-lg"
                                    onkeypress="if(event.key === 'Enter' && event.target.value.trim()) { processBarcodeAction(event.target.value.trim()); event.target.value = ''; }"
                                />
                                <button onclick="scanning = false; scanAction = null; render()" class="mt-2 text-sm text-blue-700 hover:text-blue-900 font-medium">
                                    Cancel Scanning
                                </button>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Filters -->
                    <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="md:col-span-2">
                                <input
                                    type="text"
                                    placeholder="üîç Search by name, code, barcode..."
                                    value="${searchTerm}"
                                    oninput="searchTerm = this.value; render()"
                                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500"
                                />
                            </div>
                            <select onchange="filterCategory = this.value; render()" class="px-4 py-2 border rounded-lg">
                                <option value="All">All Categories</option>
                                ${categories.map(cat => `<option value="${cat}" ${filterCategory === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                            </select>
                            <select onchange="filterStatus = this.value; render()" class="px-4 py-2 border rounded-lg">
                                <option value="All" ${filterStatus === 'All' ? 'selected' : ''}>All Status</option>
                                <option value="OK" ${filterStatus === 'OK' ? 'selected' : ''}>OK</option>
                                <option value="Low Stock" ${filterStatus === 'Low Stock' ? 'selected' : ''}>Low Stock</option>
                                <option value="Out of Stock" ${filterStatus === 'Out of Stock' ? 'selected' : ''}>Out of Stock</option>
                            </select>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Code</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Product</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Category</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Opening</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Purchased</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Sold</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Current</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Cost</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Value</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredProducts.map(product => {
                                        const currentStock = calculateCurrentStock(product);
                                        const inventoryValue = calculateInventoryValue(product);
                                        const status = getStatus(product);
                                        return `
                                            <tr class="border-b hover:bg-blue-50">
                                                <td class="px-4 py-3 font-mono text-sm font-semibold text-blue-600">${product.productCode}</td>
                                                <td class="px-4 py-3 font-semibold">${product.name}</td>
                                                <td class="px-4 py-3"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${product.category}</span></td>
                                                <td class="px-4 py-3 text-right text-gray-600">${product.openingStock}</td>
                                                <td class="px-4 py-3 text-right">
                                                    <div class="flex items-center justify-end gap-1">
                                                        <button onclick="updateTransaction('${product.id}', 'purchased', 1)" class="p-1 text-green-600 hover:bg-green-50 rounded">‚ûï</button>
                                                        <span class="text-green-600 font-semibold min-w-[30px] text-center">${product.purchased}</span>
                                                        <button onclick="updateTransaction('${product.id}', 'purchased', -1)" class="p-1 text-red-600 hover:bg-red-50 rounded">‚ûñ</button>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <div class="flex items-center justify-end gap-1">
                                                        <button onclick="updateTransaction('${product.id}', 'sold', 1)" class="p-1 text-green-600 hover:bg-green-50 rounded">‚ûï</button>
                                                        <span class="text-red-600 font-semibold min-w-[30px] text-center">${product.sold}</span>
                                                        <button onclick="updateTransaction('${product.id}', 'sold', -1)" class="p-1 text-red-600 hover:bg-red-50 rounded">‚ûñ</button>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <span class="font-bold text-lg ${currentStock <= 0 ? 'text-red-600' : currentStock <= product.threshold ? 'text-orange-600' : 'text-gray-800'}">
                                                        ${currentStock}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-right">‚Çπ${product.unitCost.toFixed(2)}</td>
                                                <td class="px-4 py-3 text-right font-semibold text-blue-600">‚Çπ${inventoryValue.toFixed(2)}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${status.color}">${status.label}</span>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex justify-center gap-2">
                                                        <button onclick="editingProduct = products.find(p => p.id === '${product.id}'); render()" class="p-1 text-blue-600 hover:bg-blue-50 rounded">‚úèÔ∏è</button>
                                                        <button onclick="deleteProduct('${product.id}')" class="p-1 text-red-600 hover:bg-red-50 rounded">üóëÔ∏è</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${filteredProducts.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <p class="text-lg">üì¶ No products found</p>
                                <p class="text-sm">Add your first product to get started</p>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Add/Edit Product Modal -->
                    ${(showAddForm || editingProduct) ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-2xl font-bold">${editingProduct ? 'Edit Product' : 'Add New Product'}</h2>
                                    <button onclick="showAddForm = false; editingProduct = null; resetForm(); render()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úñÔ∏è</button>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Product Code *</label>
                                        <input type="text" id="productCode" value="${editingProduct ? editingProduct.productCode : newProduct.productCode}" 
                                            class="w-full px-4 py-2 border rounded-lg" placeholder="PRD001">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Barcode</label>
                                        <input type="text" id="barcode" value="${editingProduct ? editingProduct.barcode : newProduct.barcode}" 
                                            class="w-full px-4 py-2 border rounded-lg" placeholder="1234567890">
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Product Name *</label>
                                        <input type="text" id="name" value="${editingProduct ? editingProduct.name : newProduct.name}" 
                                            class="w-full px-4 py-2 border rounded-lg" placeholder="Wireless Mouse">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Category</label>
                                        <select id="category" class="w-full px-4 py-2 border rounded-lg">
                                            ${categories.map(cat => `<option value="${cat}" ${(editingProduct ? editingProduct.category : newProduct.category) === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Unit Cost (‚Çπ)</label>
                                        <input type="number" id="unitCost" value="${editingProduct ? editingProduct.unitCost : newProduct.unitCost}" 
                                            class="w-full px-4 py-2 border rounded-lg" step="0.01" placeholder="0.00">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Opening Stock</label>
                                        <input type="number" id="openingStock" value="${editingProduct ? editingProduct.openingStock : newProduct.openingStock}" 
                                            class="w-full px-4 py-2 border rounded-lg" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Stock Threshold</label>
                                        <input type="number" id="threshold" value="${editingProduct ? editingProduct.threshold : newProduct.threshold}" 
                                            class="w-full px-4 py-2 border rounded-lg" placeholder="${defaultThreshold}">
                                    </div>
                                </div>
                                
                                <button onclick="
                                    if(editingProduct) {
                                        editingProduct.productCode = document.getElementById('productCode').value;
                                        editingProduct.barcode = document.getElementById('barcode').value;
                                        editingProduct.name = document.getElementById('name').value;
                                        editingProduct.category = document.getElementById('category').value;
                                        editingProduct.unitCost = Number(document.getElementById('unitCost').value);
                                        editingProduct.openingStock = Number(document.getElementById('openingStock').value);
                                        editingProduct.threshold = Number(document.getElementById('threshold').value);
                                        updateProduct();
                                    } else {
                                        newProduct.productCode = document.getElementById('productCode').value;
                                        newProduct.barcode = document.getElementById('barcode').value;
                                        newProduct.name = document.getElementById('name').value;
                                        newProduct.category = document.getElementById('category').value;
                                        newProduct.unitCost = Number(document.getElementById('unitCost').value);
                                        newProduct.openingStock = Number(document.getElementById('openingStock').value);
                                        newProduct.threshold = Number(document.getElementById('threshold').value);
                                        addProduct();
                                    }
                                " class="mt-6 w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
                                    üíæ ${editingProduct ? 'Update Product' : 'Add Product'}
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Settings Modal -->
                    ${showSettings ? `
                        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-2xl font-bold">‚öôÔ∏è Settings</h2>
                                    <button onclick="showSettings = false; render()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úñÔ∏è</button>
                                </div>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Default Stock Threshold</label>
                                        <input type="number" id="defaultThresholdInput" value="${defaultThreshold}" 
                                            class="w-full px-4 py-2 border rounded-lg" min="0">
                                        <p class="text-xs text-gray-500 mt-1">Products below this quantity will be marked as Low Stock</p>
                                    </div>
                                    
                                    <button onclick="
                                        defaultThreshold = Number(document.getElementById('defaultThresholdInput').value);
                                        showSettings = false;
                                        render();
                                    " class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
                                        üíæ Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Make functions globally available
        window.startScanning = startScanning;
        window.processBarcodeAction = processBarcodeAction;
        window.updateTransaction = updateTransaction;
        window.addProduct = addProduct;
        window.updateProduct = updateProduct;
        window.deleteProduct = deleteProduct;
        window.saveToGoogleSheets = saveToGoogleSheets;
        window.render = render;

        // Initial load
        loadFromGoogleSheets();
        render();
    </script>
</body>
</html>
