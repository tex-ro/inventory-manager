<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-100 min-h-screen">
    <div id="app"></div>

    <script>
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbz5IrzT5jTnsHOPRiiTvnyxRCSVrjrqrZ6jSfYYnrqz9AZdlBox6QI-34ewybZyFNqu/exec';

        let state = {
            products: [],
            categories: ['Electronics', 'Clothing', 'Food', 'Furniture', 'Books', 'Others'],
            searchTerm: '',
            filterCategory: 'All',
            filterStatus: 'All',
            scanning: false,
            scanAction: null,
            showAddForm: false,
            editingProduct: null,
            showSettings: false,
            defaultThreshold: 10,
            syncing: false,
            lastSync: null,
            showLowStock: false,
            scannedItems: []
        };

        async function loadData() {
            try {
                state.syncing = true;
                render();
                const response = await fetch(GOOGLE_SHEET_URL);
                const data = await response.json();
                if (data.products && data.products.length > 0) {
                    state.products = data.products.map((p, i) => ({...p, id: Date.now() + i}));
                }
                state.lastSync = new Date();
            } catch (error) {
                console.error('Load error:', error);
            } finally {
                state.syncing = false;
                render();
            }
        }

        async function saveData() {
            try {
                state.syncing = true;
                render();
                await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({products: state.products})
                });
                state.lastSync = new Date();
                setTimeout(() => loadData(), 1000);
            } catch (error) {
                console.error('Save error:', error);
            } finally {
                state.syncing = false;
                render();
            }
        }

        function getCurrentStock(product) {
            return product.openingStock + product.purchased - product.sold;
        }

        function getInventoryValue(product) {
            return getCurrentStock(product) * product.unitCost;
        }

        function getStatus(product) {
            const stock = getCurrentStock(product);
            if (stock <= 0) return {label: 'Out', color: 'bg-red-100 text-red-600'};
            if (stock <= product.threshold) return {label: 'Low', color: 'bg-orange-100 text-orange-600'};
            return {label: 'OK', color: 'bg-green-100 text-green-600'};
        }

        function addProduct() {
            const code = document.getElementById('pCode').value.trim();
            const name = document.getElementById('pName').value.trim();
            if (!code || !name) {
                alert('Product Code and Name required');
                return;
            }
            state.products.push({
                id: Date.now(),
                productCode: code,
                barcode: document.getElementById('pBarcode').value.trim(),
                name: name,
                category: document.getElementById('pCategory').value,
                openingStock: Number(document.getElementById('pOpening').value) || 0,
                purchased: 0,
                sold: 0,
                unitCost: Number(document.getElementById('pCost').value) || 0,
                threshold: Number(document.getElementById('pThreshold').value) || state.defaultThreshold,
                supplierName: document.getElementById('pSupplierName').value.trim(),
                supplierNumber: document.getElementById('pSupplierNumber').value.trim()
            });
            state.showAddForm = false;
            saveData();
        }

        function updateProduct() {
            const p = state.editingProduct;
            p.productCode = document.getElementById('pCode').value.trim();
            p.barcode = document.getElementById('pBarcode').value.trim();
            p.name = document.getElementById('pName').value.trim();
            p.category = document.getElementById('pCategory').value;
            p.unitCost = Number(document.getElementById('pCost').value) || 0;
            p.openingStock = Number(document.getElementById('pOpening').value) || 0;
            p.threshold = Number(document.getElementById('pThreshold').value) || state.defaultThreshold;
            p.supplierName = document.getElementById('pSupplierName').value.trim();
            p.supplierNumber = document.getElementById('pSupplierNumber').value.trim();
            state.products = state.products.map(pr => pr.id === p.id ? p : pr);
            state.editingProduct = null;
            saveData();
        }

        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                state.products = state.products.filter(p => p.id !== id);
                saveData();
            }
        }

        function updateTransaction(id, type, change) {
            state.products = state.products.map(p => 
                p.id === id ? {...p, [type]: Math.max(0, p[type] + change)} : p
            );
            saveData();
        }

        function startScan(action) {
            state.scanAction = action;
            state.scanning = true;
            state.scannedItems = [];
            render();
            setTimeout(() => document.getElementById('scanInput')?.focus(), 100);
        }

        function processScan(barcode) {
            const product = state.products.find(p => p.barcode === barcode || p.productCode === barcode);
            if (product) {
                if (state.scanAction === 'purchase') {
                    updateTransaction(product.id, 'purchased', 1);
                } else if (state.scanAction === 'sale') {
                    updateTransaction(product.id, 'sold', 1);
                }
                state.scannedItems.push({
                    name: product.name,
                    code: product.productCode,
                    action: state.scanAction,
                    time: new Date().toLocaleTimeString()
                });
            } else {
                state.scannedItems.push({
                    name: 'Unknown Product',
                    code: barcode,
                    action: 'error',
                    time: new Date().toLocaleTimeString()
                });
            }
            render();
            setTimeout(() => document.getElementById('scanInput')?.focus(), 100);
        }

        function stopScanning() {
            state.scanning = false;
            state.scannedItems = [];
            render();
        }

        function getFilteredProducts() {
            return state.products.filter(p => {
                const search = state.searchTerm.toLowerCase();
                const matchSearch = !search || 
                    p.name.toLowerCase().includes(search) ||
                    p.productCode.toLowerCase().includes(search) ||
                    (p.barcode && p.barcode.toLowerCase().includes(search));
                
                const matchCategory = state.filterCategory === 'All' || p.category === state.filterCategory;
                const matchStatus = state.filterStatus === 'All' || getStatus(p).label === state.filterStatus;
                
                return matchSearch && matchCategory && matchStatus;
            });
        }

        function getLowStockProducts() {
            return state.products.filter(p => {
                const status = getStatus(p);
                return status.label === 'Low' || status.label === 'Out';
            });
        }

        function getTotalPurchases() {
            return state.products.reduce((sum, p) => sum + p.purchased, 0);
        }

        function getTotalSales() {
            return state.products.reduce((sum, p) => sum + p.sold, 0);
        }

        function getTotalPurchaseValue() {
            return state.products.reduce((sum, p) => sum + (p.purchased * p.unitCost), 0);
        }

        function getTotalSalesValue() {
            return state.products.reduce((sum, p) => sum + (p.sold * p.unitCost), 0);
        }

        function render() {
            const filtered = state.showLowStock ? getLowStockProducts() : getFilteredProducts();
            const totalValue = state.products.reduce((sum, p) => sum + getInventoryValue(p), 0);
            const lowStock = getLowStockProducts().length;
            const totalPurchases = getTotalPurchases();
            const totalSales = getTotalSales();
            const totalPurchaseValue = getTotalPurchaseValue();
            const totalSalesValue = getTotalSalesValue();

            document.getElementById('app').innerHTML = `
                <div class="max-w-7xl mx-auto p-4">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-3xl font-bold text-gray-800">üì¶ Inventory Manager</h1>
                            <button onclick="state.showAddForm = true; render()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                ‚ûï Add Product
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <div class="bg-blue-100 p-4 rounded-lg">
                                <div class="text-sm text-blue-600 font-medium">Inventory Value</div>
                                <div class="text-2xl font-bold text-blue-900">‚Çπ${totalValue.toFixed(0)}</div>
                            </div>
                            <div class="bg-purple-100 p-4 rounded-lg">
                                <div class="text-sm text-purple-600 font-medium">Products</div>
                                <div class="text-2xl font-bold text-purple-900">${state.products.length}</div>
                            </div>
                            <div class="bg-orange-100 p-4 rounded-lg cursor-pointer hover:bg-orange-200" onclick="state.showLowStock = !state.showLowStock; render()">
                                <div class="text-sm text-orange-600 font-medium">Low Stock ‚ö†Ô∏è</div>
                                <div class="text-2xl font-bold text-orange-900">${lowStock}</div>
                            </div>
                            <div class="bg-green-100 p-4 rounded-lg">
                                <div class="text-sm text-green-600 font-medium">Total Purchases</div>
                                <div class="text-xl font-bold text-green-900">${totalPurchases} (‚Çπ${totalPurchaseValue.toFixed(0)})</div>
                            </div>
                            <div class="bg-red-100 p-4 rounded-lg">
                                <div class="text-sm text-red-600 font-medium">Total Sales</div>
                                <div class="text-xl font-bold text-red-900">${totalSales} (‚Çπ${totalSalesValue.toFixed(0)})</div>
                            </div>
                            <div class="bg-teal-100 p-4 rounded-lg">
                                <div class="text-sm text-teal-600 font-medium">Status</div>
                                <div class="text-lg font-bold text-teal-900">${state.syncing ? 'Syncing...' : 'Ready'}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">üîç Barcode Scanner</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <button onclick="startScan('purchase')" class="bg-green-600 text-white px-6 py-4 rounded-lg font-semibold hover:bg-green-700">
                                üõí Scan for Purchase
                            </button>
                            <button onclick="startScan('sale')" class="bg-red-600 text-white px-6 py-4 rounded-lg font-semibold hover:bg-red-700">
                                üí∞ Scan for Sale
                            </button>
                        </div>
                        ${state.scanning ? `
                            <div class="mt-4 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="font-bold text-blue-900">Scanning for ${state.scanAction === 'purchase' ? 'Purchase üõí' : 'Sale üí∞'}</h3>
                                    <button onclick="stopScanning()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Stop Scanning</button>
                                </div>
                                <input id="scanInput" type="text" placeholder="Scan barcode and press Enter..." 
                                    class="w-full px-4 py-2 border rounded-lg mb-3" 
                                    onkeypress="if(event.key==='Enter' && this.value.trim()){processScan(this.value.trim()); this.value='';}">
                                ${state.scannedItems.length > 0 ? `
                                    <div class="mt-3 max-h-40 overflow-y-auto">
                                        <h4 class="font-semibold mb-2">Scanned Items:</h4>
                                        ${state.scannedItems.slice().reverse().map(item => `
                                            <div class="p-2 mb-1 rounded ${item.action === 'error' ? 'bg-red-100' : 'bg-green-100'}">
                                                <span class="font-semibold">${item.name}</span> - ${item.code} 
                                                <span class="text-xs text-gray-600">(${item.time})</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>

                    ${state.showLowStock ? `
                        <div class="bg-orange-50 border-2 border-orange-300 rounded-xl p-4 mb-6">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-bold text-orange-900">‚ö†Ô∏è Low Stock Alert (${lowStock} items)</h2>
                                <button onclick="state.showLowStock = false; render()" class="text-orange-600 hover:text-orange-800">
                                    ‚úï Close
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    ${!state.showLowStock ? `
                        <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                            <div class="grid md:grid-cols-3 gap-4">
                                <input type="text" placeholder="üîç Search..." 
                                    value="${state.searchTerm}"
                                    oninput="state.searchTerm=this.value; render()"
                                    class="px-4 py-2 border rounded-lg">
                                <select onchange="state.filterCategory=this.value; render()" class="px-4 py-2 border rounded-lg">
                                    <option value="All">All Categories</option>
                                    ${state.categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                                <select onchange="state.filterStatus=this.value; render()" class="px-4 py-2 border rounded-lg">
                                    <option value="All">All Status</option>
                                    <option value="OK">OK</option>
                                    <option value="Low">Low Stock</option>
                                    <option value="Out">Out of Stock</option>
                                </select>
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-blue-600 text-white">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Code</th>
                                        <th class="px-4 py-3 text-left">Product</th>
                                        <th class="px-4 py-3 text-left">Category</th>
                                        <th class="px-4 py-3 text-left">Supplier</th>
                                        <th class="px-4 py-3 text-right">Opening</th>
                                        <th class="px-4 py-3 text-right">Purchased</th>
                                        <th class="px-4 py-3 text-right">Sold</th>
                                        <th class="px-4 py-3 text-right">Stock</th>
                                        <th class="px-4 py-3 text-right">Value</th>
                                        <th class="px-4 py-3 text-center">Status</th>
                                        <th class="px-4 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filtered.map(p => {
                                        const stock = getCurrentStock(p);
                                        const value = getInventoryValue(p);
                                        const status = getStatus(p);
                                        const purchaseValue = p.purchased * p.unitCost;
                                        const salesValue = p.sold * p.unitCost;
                                        return `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-4 py-3 font-mono font-semibold text-blue-600">${p.productCode}</td>
                                                <td class="px-4 py-3 font-semibold">${p.name}</td>
                                                <td class="px-4 py-3 text-gray-600">${p.category}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    ${p.supplierName ? `
                                                        <div class="font-medium">${p.supplierName}</div>
                                                        ${p.supplierNumber ? `<div class="text-gray-500">${p.supplierNumber}</div>` : ''}
                                                    ` : '<span class="text-gray-400">-</span>'}
                                                </td>
                                                <td class="px-4 py-3 text-right">${p.openingStock}</td>
                                                <td class="px-4 py-3 text-right">
                                                    <button onclick="updateTransaction(${p.id}, 'purchased', -1)" class="text-red-600 px-1">-</button>
                                                    <span class="font-semibold text-green-600 mx-2">${p.purchased}</span>
                                                    <button onclick="updateTransaction(${p.id}, 'purchased', 1)" class="text-green-600 px-1">+</button>
                                                    <div class="text-xs text-gray-500">‚Çπ${purchaseValue.toFixed(0)}</div>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <button onclick="updateTransaction(${p.id}, 'sold', -1)" class="text-red-600 px-1">-</button>
                                                    <span class="font-semibold text-red-600 mx-2">${p.sold}</span>
                                                    <button onclick="updateTransaction(${p.id}, 'sold', 1)" class="text-green-600 px-1">+</button>
                                                    <div class="text-xs text-gray-500">‚Çπ${salesValue.toFixed(0)}</div>
                                                </td>
                                                <td class="px-4 py-3 text-right font-bold text-lg">${stock}</td>
                                                <td class="px-4 py-3 text-right font-bold text-blue-900">‚Çπ${value.toFixed(0)}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${status.color}">${status.label}</span>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <button onclick="state.editingProduct=state.products.find(pr=>pr.id===${p.id}); render()" class="text-blue-600 mx-1">‚úèÔ∏è</button>
                                                    <button onclick="deleteProduct(${p.id})" class="text-red-600 mx-1">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        ${filtered.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <p class="text-lg">üì¶ No products found</p>
                            </div>
                        ` : ''}
                    </div>
                </div>

                ${(state.showAddForm || state.editingProduct) ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">${state.editingProduct ? 'Edit' : 'Add'} Product</h2>
                                <button onclick="state.showAddForm=false; state.editingProduct=null; render()" class="text-2xl">√ó</button>
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold mb-1">Product Code *</label>
                                    <input type="text" id="pCode" value="${state.editingProduct ? state.editingProduct.productCode : ''}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Barcode</label>
                                    <input type="text" id="pBarcode" value="${state.editingProduct ? state.editingProduct.barcode : ''}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-bold mb-1">Product Name *</label>
                                    <input type="text" id="pName" value="${state.editingProduct ? state.editingProduct.name : ''}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Supplier Name</label>
                                    <input type="text" id="pSupplierName" value="${state.editingProduct ? (state.editingProduct.supplierName || '') : ''}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Supplier Number</label>
                                    <input type="text" id="pSupplierNumber" value="${state.editingProduct ? (state.editingProduct.supplierNumber || '') : ''}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Category</label>
                                    <select id="pCategory" class="w-full px-4 py-2 border rounded-lg">
                                        ${state.categories.map(c => `<option value="${c}" ${(state.editingProduct && state.editingProduct.category === c) ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Unit Cost (‚Çπ)</label>
                                    <input type="number" id="pCost" value="${state.editingProduct ? state.editingProduct.unitCost : 0}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Opening Stock</label>
                                    <input type="number" id="pOpening" value="${state.editingProduct ? state.editingProduct.openingStock : 0}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold mb-1">Threshold</label>
                                    <input type="number" id="pThreshold" value="${state.editingProduct ? state.editingProduct.threshold : state.defaultThreshold}" 
                                        class="w-full px-4 py-2 border rounded-lg">
                                </div>
                            </div>
                            <button onclick="${state.editingProduct ? 'updateProduct()' : 'addProduct()'}" 
                                class="mt-6 w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
                                üíæ ${state.editingProduct ? 'Update' : 'Add'} Product
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        loadData();
    </script>
</body>
</html>
